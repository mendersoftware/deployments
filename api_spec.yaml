swagger: '2.0'
info:
  title: Deployments Service API
  version: '0.0.1'
  description: |
    ### Common information about all exposed API endpoints.
    
    CORS and none-CORS requests are supported. Details [wikipedia](https://en.wikipedia.org/wiki/Cross-origin_resource_sharing#Simple_example).

    Allows `Location` header exposure.
    
    ### Device endpoints and Authorization
    
    Incoming requests must set `Authorization` header and include device token
    obtained from the API. The header shall look like this:

    ```
    Authorization: Bearer <token>
    # example
    Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ
    ```
responses:
  NotFoundError: # 404
    description: Not Found
    schema:
      $ref: "#/definitions/SimpleError"
  InternalServerError: # 500
    description: Internal Server Error
    schema:
      $ref: "#/definitions/SimpleError"
  InvalidRequestError: # 400
    description: Invalid Request
    schema:
      $ref: "#/definitions/SimpleError"      

paths:
  '/device/update':
    get:
      summary: List next update to be installed on the device
      parameters:
        - name: Authorization
          in: header
          description: Device ID
          required: true
          type: string
      produces:
        - application/json
      responses:
        200:
          description: OK
          examples:
            application/json:
              image:
                uri: 'https://aws.my_update_bucket.com/yocto_image123'
                checksum: cc436f982bc60a8255fe1926a450db5f195a19ad
                id: f81d4fae-7dec-11d0-a765-00a0c91e6bf6
                expire: 2016-03-11T13:03:17.063493443Z
                yocto_id: core-image-full-cmdline-20160330201408
              id: w81s4fae-7dec-11d0-a765-00a0c91e6bf6
          schema:
            type: object
            properties:
              id:
                type: string
              image:
                type: object
                properties:
                  uri:
                    type: string
                  checksum:
                    type: string
                  id:
                    type: string
                  expire:
                    type: string
                    format: date-time
                  yocto_id:
                    type: string
                required:
                  - uri
                  - id
                  - yocto_id
            required:
              - image
              - id
        204:
          description: No updates for device
        404:
          $ref: "#/responses/NotFoundError"
        500:
          $ref: "#/responses/InternalServerError"

  '/device/deployments/{id}/status':
    put:
      summary: Update device deployment status
      description: |
        Update the status of a deployment on a particular device. Final status
        of the deployment is required to be set to indicate the success or failure 
        of the installation process. Reporting of intermediate steps such as installing,
        downloading, rebooting is optional.
      parameters:
        - name: id
          in: path
          description: Deployment identifier
          required: true
          type: string
        - name: Authorization
          in: header
          description: Device ID
          required: true
          type: string
        - name: Status
          in: body
          description: Deployment status
          required: true
          schema:
            type: object
            properties:
              status:
                type: string
                enum:
                  - installing
                  - downloading
                  - rebooting
                  - success
                  - failure
            required:
              - status
      produces:
        - application/json
      responses:
        204:
          description: Status updated
        400:
          $ref: "#/responses/InvalidRequestError"
        404:
          $ref: "#/responses/NotFoundError"
        500:
          $ref: "#/responses/InternalServerError"

  '/device/deployments/{id}/log':
    put:
      summary: Upload device deployment log
      description: |
        Set deployment log. Messages are split by line in the payload.
      parameters:
        - name: id
          in: path
          description: Deployment identifier
          required: true
          type: string
        - name: Authorization
          in: header
          description: Device ID
          required: true
          type: string
        - name: Log
          in: body
          description: Deployment log
          required: true
          schema:
            type: object
            properties:
              messages:
                type: array
                items:
                  type: object
                  properties:
                    timestamp:
                      type: string
                      format: date-time
                    level:
                      type: string
                    message:
                      type: string
                  required:
                    - timestamp
                    - level
                    - message
            required:
              - messages
      produces:
        - application/json
      responses:
        204:
          description: Deployment log uploaded
        400:
          $ref: "#/responses/InvalidRequestError"
        404:
          $ref: "#/responses/NotFoundError"
        500:
          $ref: "#/responses/InternalServerError"

  /deployments:
    get:
      summary: Find deployments
      description: |
        Lookup deployments in the system, including active and history.
      parameters:
        - name: status
          in: query
          description: Deployment status
          required: false
          type: string
          enum:
            - inprogress
            - finished
            - pending
        - name: search
          in: query
          description: Deployment name or description
          required: false
          type: string
      produces:
        - application/json
      responses:
        200:
          description: OK
          examples:
            application/json:
              - created: 2016-02-11T13:03:17.063493443Z
                status: finished
                name: production
                artifact_name: Application 0.0.1
                id: 00a0c91e6-7dec-11d0-a765-f81d4faebf6
                finished: 2016-03-11T13:03:17.063493443Z
          schema:
            type: array
            items:
              type: object
              properties:
                created:
                  type: string
                  format: date-time
                name:
                  type: string
                artifact_name:
                  type: string
                id:
                  type: string
                finished:
                  type: string
                  format: date-time
                status:
                  type: string
                  enum:
                    - inprogress
                    - pending
                    - finished
              required:
                - created
                - name
                - artifact_name
                - id
                - status
        400:
          $ref: "#/responses/InvalidRequestError"
        500:
          $ref: "#/responses/InternalServerError"

    post:
      summary: Create deployment
      description: |
        Deploy software to specified devices. Image is auto assigned to the
        device from all available images based on artifact name and device type.

        NOTE: Because of lack of inventory system, service assumes hardcoded
        device type for each device: "TestDevice"

      parameters:
        - name: Body
          in: body
          schema:
            type: object
            properties:
              name:
                type: string
              artifact_name:
                type: string
              devices:
                type: array
                items:
                  type: string
            required:
              - name
              - artifact_name
              - devices
      produces:
        - application/json
      responses:
        201:
          description: Created
          headers:
            Location:
              description: URL of newly created deployment
              type: string
        400:
          $ref: "#/responses/InvalidRequestError"
        500:
          $ref: "#/responses/InternalServerError"

  '/deployments/{id}':
    get:
      summary: Deployment details
      parameters:
        - name: id
          in: path
          description: Deployment identifier
          required: true
          type: string
      produces:
        - application/json
      responses:
        200:
          description: OK
          examples:
            application/json:
              created: 2016-02-11T13:03:17.063493443Z
              name: production
              artifact_name: Application 0.0.1
              id: 00a0c91e6-7dec-11d0-a765-f81d4faebf6
              finished: 2016-03-11T13:03:17.063493443Z
          schema:
            type: object
            properties:
              created:
                type: string
                format: date-time
              name:
                type: string
              artifact_name:
                type: string
              id:
                type: string
              finished:
                type: string
                format: date-time
            required:
              - created
              - name
              - artifact_name
              - id
        404:
          $ref: "#/responses/NotFoundError"
        500:
          $ref: "#/responses/InternalServerError"

    delete:
      summary: Cancel deployment
      description: |
        Cancels a deployment
        TODO: to be implemented

      parameters:
        - name: id
          in: path
          description: Deployment identifier
          required: true
          type: string
      produces:
        - application/json
      responses:
        204:
          description: Deployment canceled
        404:
          $ref: "#/responses/NotFoundError"
        500:
          $ref: "#/responses/InternalServerError"

  '/deployments/{deployment_id}/statistics':
    get:
      summary: Deployment statistics
      parameters:
        - name: deployment_id
          in: path
          description: Deployment identifier
          required: true
          type: string
      produces:
        - application/json
      responses:
        200:
          description: OK
          examples:
            application/json:
              success: 3
              pending: 1
              failure: 0
              downloading: 1
              installing: 2
              rebooting: 3
              noimage: 0
          schema:
            type: object
            properties:
              success:
                type: integer
                description: Number of successful deployments
              pending:
                type: integer
                description: Number of pending deployments
              downloading:
                type: integer
                description: Number of deployments being downloaded
              rebooting:
                type: integer
                description: Number of deployments devices are rebooting into
              installing:
                type: integer
                description: Number of deployments devices being installed
              failure:
                type: integer
                description: Number of failed deployments
              noimage:
                type: integer
                description: Do not have apropriate image for device type
            required:
              - success
              - pending
              - downloading
              - installing
              - rebooting
              - failure
              - noimage
        404:
          $ref: "#/responses/NotFoundError"
        500:
          $ref: "#/responses/InternalServerError"

  '/deployments/{deployment_id}/devices':
    get:
      summary: List devices of a deployment
      description: |
        List deployment status for each assigned device
      parameters:
        - name: deployment_id
          in: path
          description: Deployment identifier
          required: true
          type: string
      produces:
        - application/json
      responses:
        200:
          description: OK
          examples:
            application/json:
              - id: 00a0c91e6-7dec-11d0-a765-f81d4faebf6
                finished: 2016-03-11T13:03:17.063493443Z
                status: pending
                started: 2016-02-11T13:03:17.063493443Z
                device_type: Raspberry Pi 3
                artifact_id: 60a0c91e6-7dec-11d0-a765-f81d4faebf6
          schema:
            type: array
            items:
              type: object
              properties:
                id:
                  type: string
                  description: device ID
                finished:
                  type: string
                  format: date-time
                status:
                  type: string
                  enum:
                    - inprogress
                    - pending
                    - success
                    - failure
                    - noimage
                started:
                  type: string
                  format: date-time
                device_type:
                  type: string
                artifact_id:
                  type: string
              required:
                - id
                - status
                - device_type
        404:
          $ref: "#/responses/NotFoundError"
        500:
          $ref: "#/responses/InternalServerError"

  '/deployments/{deployment_id}/devices/{device_id}/log':
    get:
      summary: Download deployment log
      description: |
        Device log collected during deployment.
      parameters:
        - name: deployment_id
          in: path
          description: Deployment identifier
          required: true
          type: string
        - name: device_id
          in: path
          description: Device identifier
          required: true
          type: string
      produces:
        - application/json
        - text/plain
      responses:
        200:
          description: Device log as text
        404:
          $ref: "#/responses/NotFoundError"
        500:
          $ref: "#/responses/InternalServerError"

  /images:
    get:
      summary: List firmware images
      produces:
        - application/json
      responses:
        200:
          description: OK
          examples:
            application/json:
              - name: MySecretApp v2
                description: Johns Monday test build
                checksum: cc436f982bc60a8255fe1926a450db5f195a19ad
                device_type: Beagle Bone
                id: 0c13a0e6-6b63-475d-8260-ee42a590e8ff
                verified: false
                modified: 2016-03-11T13:03:17.063493443Z
                yocto_id: core-image-full-cmdline-20160330201408
          schema:
            type: object
            items:
              $ref: "#/definitions/Image"

        500:
          $ref: "#/responses/InternalServerError"

    post:
      summary: Create firmware image
      description: |
        Create firmware image. Afterwards upload link can be generated to upload
        image file.
      parameters:
        - name: image
          in: body
          required: true
          schema:
            $ref: "#/definitions/ImageBase"
      produces:
        - application/json
      responses:
        201:
          description: Image created
          headers:
            Location:
              description: URL of newly created image
              type: string
        500:
          $ref: "#/responses/InternalServerError"

  '/images/{id}':
    get:
      summary: Firmare image details
      parameters:
        - name: id
          in: path
          description: Image ID
          required: true
          type: string
      produces:
        - application/json
      responses:
        200:
          description: OK
          schema:
            $ref: "#/definitions/Image"
        404:
          $ref: "#/responses/NotFoundError"
        500:
          $ref: "#/responses/InternalServerError"

    put:
      summary: Update firmware image
      description: |
        Edit image information. Image is not allowed to be edited if it was used
        in any deployment.
      parameters:
        - name: id
          in: path
          description: Image ID
          required: true
          type: string
        - name: image
          in: body
          schema:
            $ref: "#/definitions/ImageUpdate"
      produces:
        - application/json
      responses:
        204:
          description: No Content
        400:
          $ref: "#/responses/InvalidRequestError"
        404:
          $ref: "#/responses/NotFoundError"
        500:
          $ref: "#/responses/InternalServerError"

    delete:
      summary: Remove firmware image
      produces:
        - application/json
      parameters:
        - name: id
          in: path
          description: Image ID
          required: true
          type: string
      responses:
        204:
          description: No Content
        404:
          $ref: "#/responses/NotFoundError"
        500:
          $ref: "#/responses/InternalServerError"

  '/images/{id}/upload':
    get:
      summary: Generate upload link
      description: |
        Generate signed URL for uploading image file. URI can be used only with PUT HTTP method.
        It is valid for specified period if time.

        In case link is used multiple times to upload file, file will be
        overwritten.
      parameters:
        - name: id
          in: path
          description: Image ID
          required: true
          type: string
        - name: expire
          in: query
          description: |
            Link validity length in minutes. Min 1 minute, max 10080 (1 week)
          required: false
          type: integer
          default: 60
      produces:
        - application/json
      responses:
        200:
          description: OK
          schema:
            $ref: "#/definitions/ImageLink"
          examples:
            application/json:
              uri: 'https://exmple.com/file123'
              expire: '2016-03-11T13:03:17.063493443Z'
        400:
          description: Bad Request
          examples:
            application/json:
              error: Detailed error message
          schema:
            $ref: "#/definitions/SimpleError"
        404:
          description: Not Found
          examples:
            application/json:
              error: Detailed error message
          schema:
            $ref: "#/definitions/SimpleError"
        500:
          description: Internal Server Error
          examples:
            application/json:
              error: Detailed error message
          schema:
            $ref: "#/definitions/SimpleError"

  '/images/{id}/download':
    get:
      summary: Generate download link
      description: |
        Generate signed URL for downloading image file. URI can be used only
        with GET HTTP method. Link supports such HTTP headers: `Range`,
        `If-Modified-Since`, `If-Unmodified-Since` It is valid for specified
        period of time.

        To be able to recieve download link, image file have to be uploaded
        first.
      parameters:
        - name: id
          in: path
          description: Image ID
          required: true
          type: string
        - name: expire
          in: query
          description: |
            Link validity length in minutes. Min 1 minute, max 10080 (1 week)
          required: false
          type: integer
          default: 60
      produces:
        - application/json
      responses:
        200:
          description: OK
          schema:
            $ref: "#/definitions/ImageLink"
        400:
          description: Bad Request
          examples:
            application/json:
              error: Detailed error message
          schema:
            $ref: "#/definitions/SimpleError"
        404:
          description: Not Found
          examples:
            application/json:
              error: Detailed error message
          schema:
            $ref: "#/definitions/SimpleError"
        500:
          description: Internal Server Error
          examples:
            application/json:
              error: Detailed error message
          schema:
            $ref: "#/definitions/SimpleError"

definitions:
  SimpleError:
    description: Simple error descriptor
    type: object
    properties:
      error:
        description: Description of error
        type: string
  ImageBase:
    description: Base firmware image
    type: object
    properties:
      name:
        type: string
      description:
        type: string
      checksum:
        type: string
      device_type:
        type: string
    required:
      - name
      - description
      - device_type
      - checksum
  ImageUpdate:
    description: Firmware image information update
    allOf:
      - $ref: "#/definitions/ImageBase"
    required:
      - name
      - description
      - device_type
  Image:
    description: Detailed firmware image
    allOf:
      - $ref: "#/definitions/ImageBase"
      - type: object
        properties:
          id:
            type: string
          verified:
            type: boolean
          modified:
            type: string
            format: date-time
            description: |
              Represents creation / last edition of any of the image properties,
              including image file upload or rewrite
        required:
          - id
          - verified
          - modified
  ImageLink:
    description: URL for firmare image upload/download
    type: object
    properties:
      uri:
        type: string
      expire:
        type: string
        format: date-time
    required:
      - uri
      - expire
